<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APC Preventive Maintenance</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-image {
            background-image: url('Background.jpg');
            background-size: cover;
            background-position: center;
        }
        /* Simple loading spinner */
        #loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide scrollbar for clean look */
        #recent-activities-container::-webkit-scrollbar {
            display: none;
        }
        #recent-activities-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* --- STYLES FOR NEW PM MODAL --- */
        
        /* STYLING FOR NEW PM MODAL ICONS */
        .pm-icon-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px; /* 5rem */
            height: 80px; /* 5rem */
            border-radius: 9999px; /* full */
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 3px solid white;
            background-color: transparent; /* Transparent fill */
            position: relative; /* For z-index */
            z-index: 30; /* On top of image */
        }
        .pm-icon-button:hover {
            transform: scale(1.1) rotate(5deg);
        }
        .pm-icon-label {
            font-size: 0.75rem; /* 12px */
            font-weight: 600; /* semibold */
            margin-top: 4px; /* Increased margin */
            display: block; /* Ensure it's always visible */
        }
        
        /* Icon Glow and Color States */
        .pm-icon-button.pending {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
        }
        .pm-icon-button.pending svg {
            filter: drop-shadow(0 0 5px #3b82f6);
        }
        
        .pm-icon-button.ok {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
            box-shadow: 0 0 15px #22c55e;
        }
        .pm-icon-button.ok svg {
            filter: drop-shadow(0 0 5px #22c55e);
        }

        .pm-icon-button.error {
            border-color: #ef4444; /* red-500 */
            color: #ef4444;
            box-shadow: 0 0 15px #ef4444;
        }
        .pm-icon-button.error svg {
            filter: drop-shadow(0 0 5px #ef4444);
        }
        
        .pm-icon-button.disabled {
            border-color: #6b7280; /* gray-500 */
            color: #6b7280;
            box-shadow: none;
            opacity: 0.3;
            pointer-events: none;
        }

        /* For mobile */
        @media (max-width: 640px) {
            .pm-icon-button {
                width: 60px;
                height: 60px;
                border-width: 2px;
            }
            .pm-icon-label {
                font-size: 0.65rem; /* 10px */
                margin-top: 2px;
            }
        }
        
        /* Button style for popup choices */
        .pm-choice-button {
            @apply w-full text-center py-4 px-5 rounded-2xl font-semibold text-lg border-2 cursor-pointer transition-all text-gray-800;
        }
        
        /* --- Animated Circles --- */
        #pm-interactive-container .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 10; /* Behind image */
        }
        #pm-interactive-container .circles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: animate-circles 25s linear infinite;
            bottom: -150px;
            border-radius: 50%;
        }
        #pm-interactive-container .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        #pm-interactive-container .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        #pm-interactive-container .circles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        #pm-interactive-container .circles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        #pm-interactive-container .circles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        #pm-interactive-container .circles li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        #pm-interactive-container .circles li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        #pm-interactive-container .circles li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        #pm-interactive-container .circles li:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        #pm-interactive-container .circles li:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

        @keyframes animate-circles {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.5; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }
        
        /* NEW: Dashboard Backgrounds */
        .dashboard-main {
            background-image: url('arab-potash-company-banner.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        .dashboard-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Dark overlay */
            z-index: 1;
        }
        .dashboard-content {
            position: relative;
            z-index: 2;
        }
        .content-card {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white card */
        }
        
        /* Dark mode for admin cards */
        .admin-dashboard-main {
            background-image: url('arab-potash-company-banner.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        .admin-dashboard-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(20, 20, 30, 0.7); /* Darker overlay for admin */
            z-index: 1;
        }
        .admin-dashboard-content {
            position: relative;
            z-index: 2;
        }
        .admin-content-card {
            background-color: rgba(255, 255, 255, 0.98); /* Almost opaque cards */
        }
        .admin-stat-card {
            background-color: rgba(240, 245, 255, 0.95); /* Light-blueish stat cards */
            transition: all 0.2s ease-in-out;
        }
        .admin-stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body class="bg-gray-100">

    <div id="loader-overlay" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[100]">
        <div id="loader"></div>
    </div>


    <div id="app" class="h-screen w-screen">

        <!-- NEW LOGIN SCREEN -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full w-full bg-image">
            <div class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl text-center w-full max-w-md">
                <img src="arab_potash_logo.png" alt="Logo" class="mx-auto mb-6 h-24" onerror="this.src='https://placehold.co/150x100/FFFFFF/333333?text=Logo+Not+Found'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">PM Application</h1>
                
                <div id="user-login">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">User Login</h2>
                    <input type="password" id="user-password-input" placeholder="Enter Your Password" class="w-full p-3 border border-gray-300 rounded-lg text-center text-lg">
                    <button onclick="loginUserWithPassword()" class="w-full mt-4 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Login</button>
                    <button onclick="showAdminLogin()" class="mt-6 text-gray-600 hover:text-blue-600 font-medium">Login as Admin</button>
                </div>
                
                <div id="admin-login" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Admin Login</h2>
                    <p class="text-md text-gray-500 mb-4">Eng. Osama Al-Samirat</p>
                    <input type="password" id="admin-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg">
                    <div class="flex items-center justify-start my-4">
                        <input id="admin-remember-me" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <label for="admin-remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                    <button onclick="loginAdmin()" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition">Login</button>
                    <button onclick="showUserSelection()" class="mt-4 text-gray-600 hover:text-blue-600 font-medium">Back to User Login</button>
                </div>
            </div>
            <p class="text-white text-center mt-4 text-sm font-light absolute bottom-4">Design by: Eng.Abdallah Dmour</p>
        </div>

        <!-- This modal is no longer used for login, but kept for "remember me" logic -->
        <div id="user-password-modal" class="hidden"></div>

        <div id="user-interface" class="hidden h-full flex flex-col">
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                <div class="flex items-center">
                    <img src="arab_potash_logo.png" alt="Logo" class="h-12 mr-4" onerror="this.src='https://placehold.co/100x50/FFFFFF/333333?text=Logo'">
                    <h1 class="text-2xl font-bold text-gray-800">User Dashboard</h1>
                </div>
                <div>
                    <span id="current-user" class="font-semibold text-lg text-gray-700 mr-4"></span>
                    <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </header>
            <main class="flex-grow p-4 md:p-6 overflow-y-auto dashboard-main">
                <div class="dashboard-content">
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-white">Select a Task</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="content-card p-6 rounded-lg shadow-md">
                                <h3 class="font-bold text-xl text-gray-900 mb-4">Preventive Maintenance (PM)</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <button onclick="selectZone('HLP')" class="bg-yellow-500 text-white font-bold py-6 rounded-lg shadow-lg hover:bg-yellow-600 transition-transform transform hover:scale-105 text-xl">HLP</button>
                                    <button onclick="selectZone('SCREEN')" class="bg-teal-500 text-white font-bold py-6 rounded-lg shadow-lg hover:bg-teal-600 transition-transform transform hover:scale-105 text-xl">SCREEN</button>
                                    <button onclick="selectZone('COMPACTION')" class="bg-indigo-500 text-white font-bold py-6 rounded-lg shadow-lg hover:bg-indigo-600 transition-transform transform hover:scale-105 text-xl">COMPACTION</button>
                                </div>
                            </div>
                            <div id="grease-task-card" class="content-card p-6 rounded-lg shadow-md flex flex-col">
                                <h3 class="font-bold text-xl text-gray-900 mb-4">Motor Greasing</h3>
                                <button onclick="showGreaseSearch()" class="bg-green-600 text-white font-bold py-6 rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:scale-105 text-xl h-full">Log Motor Grease</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-white">Recent PM Activities</h2>
                            <div class="flex space-x-2">
                                <button onclick="scrollRecentActivities(-200)" aria-label="Scroll Up" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-2 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                </button>
                                <button onclick="scrollRecentActivities(200)" aria-label="Scroll Down" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-2 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div id="recent-activities-container" class="max-h-96 overflow-y-auto pr-2">
                            <div id="recent-activities" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                <!-- Recent activities will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
             <footer class="bg-gray-200 text-center p-4 z-10">
                 <p class="text-sm text-gray-600">Design by: Eng.Abdallah Dmour</p>
             </footer>
        </div>

        <div id="admin-interface" class="hidden h-full flex flex-col">
             <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                 <div class="flex items-center">
                     <img src="arab_potash_logo.png" alt="Logo" class="h-12 mr-4" onerror="this.src='https://placehold.co/100x50/FFFFFF/333333?text=Logo'">
                     <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                 </div>
                 <div>
                     <span class="font-semibold text-lg text-red-700 mr-4">ADMIN</span>
                     <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
                 </div>
             </header>
             <main class="flex-grow p-4 md:p-6 admin-dashboard-main overflow-y-auto">
                  <div class="admin-dashboard-content">
                     <div class="mb-6">
                         <h2 class="text-2xl font-bold text-white mb-4">Dashboard Analytics</h2>
                         <!-- NEW KPI GRID -->
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <!-- Row 1 -->
                            <div onclick="filterHistoryByAnalytics('pm_today')" class="admin-stat-card p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-blue-800" id="analytics-pm-today">0</h3>
                                <p class="text-blue-600 font-medium">PM Tasks Today</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('grease_today')" class="admin-stat-card bg-green-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-green-800" id="analytics-grease-today">0</h3>
                                <p class="text-green-600 font-medium">Grease Tasks Today</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('unresolved')" class="admin-stat-card bg-red-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-red-800" id="analytics-unresolved-errors">0</h3>
                                <p class="text-red-600 font-medium">Unresolved Errors</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('active_users')" class="admin-stat-card bg-yellow-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-yellow-800" id="analytics-users-active">0</h3>
                                <p class="text-yellow-600 font-medium">Users Active Today</p>
                            </div>
                            <!-- Row 2 -->
                            <div onclick="filterHistoryByAnalytics('pm_week')" class="admin-stat-card p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-blue-800" id="analytics-pm-week">0</h3>
                                <p class="text-blue-600 font-medium">PM Tasks This Week</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('grease_week')" class="admin-stat-card bg-green-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-green-800" id="analytics-grease-week">0</h3>
                                <p class="text-green-600 font-medium">Grease Tasks This Week</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('total_tasks_week')" class="admin-stat-card bg-indigo-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-indigo-800" id="analytics-total-tasks-week">0</h3>
                                <p class="text-indigo-600 font-medium">Total Tasks This Week</p>
                            </div>
                            <div onclick="filterHistoryByAnalytics('total_errors_week')" class="admin-stat-card bg-red-50 p-4 rounded-lg shadow cursor-pointer">
                                <h3 class="font-bold text-3xl text-red-800" id="analytics-total-errors-week">0</h3>
                                <p class="text-red-600 font-medium">Total Errors This Week</p>
                            </div>
                        </div>
                     </div>

                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="admin-content-card p-6 rounded-lg shadow-md">
                             <h2 class="text-2xl font-bold text-gray-800 mb-4">Live PM Activities</h2>
                             <div id="admin-live-activities" class="space-y-4 max-h-screen overflow-y-auto">
                                 <!-- Live activities will be populated here -->
                             </div>
                         </div>
                         <div class="admin-content-card p-6 rounded-lg shadow-md space-y-6">
                             <div>
                                 <h2 class="text-2xl font-bold text-gray-800">History & Reports</h2>
                                 <div class="border-b border-gray-200">
                                     <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                         <button onclick="switchAdminView('pm')" id="tab-pm" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                                             PM History
                                         </button>
                                         <button onclick="switchAdminView('grease')" id="tab-grease" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                             Grease History
                                         </button>
                                     </nav>
                                 </div>
        
                                 <div id="pm-view">
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4 p-4 bg-gray-50 rounded-lg border">
                                         <input type="text" id="history-search-text" placeholder="Search PM by User or TAG..." class="p-2 border rounded-lg w-full">
                                         <input type="date" id="history-search-date" class="p-2 border rounded-lg w-full">
                                     </div>
                                     <div class="flex space-x-4 my-4">
                                         <button onclick="exportToExcel()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Export PM to Excel</button>
                                         <button onclick="exportToPDF()" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Export PM to PDF</button>
                                     </div>
                                     <div id="admin-history" class="h-80 overflow-y-auto border rounded-lg p-2 bg-white"></div>
                                 </div>
        
                                 <div id="grease-view" class="hidden">
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4 p-4 bg-gray-50 rounded-lg border">
                                         <input type="text" id="grease-search-text" placeholder="Search Grease by User or TAG..." class="p-2 border rounded-lg w-full">
                                         <input type="date" id="grease-search-date" class="p-2 border rounded-lg w-full">
                                     </div>
                                     <div class="flex space-x-4 my-4">
                                         <button onclick="exportGreaseToExcel()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Export Grease to Excel</button>
                                     </div>
                                     <div id="admin-grease-history" class="h-80 overflow-y-auto border rounded-lg p-2 bg-white"></div>
                                 </div>
                             </div>
                            
                              <div class="space-y-6 border-t pt-6">
                                  <div id="data-management" class="space-y-4 border p-4 rounded-lg bg-white">
                                      <h3 class="font-semibold text-lg text-gray-700">Automated Archiving Schedule</h3>
                                      <p class="text-sm text-gray-600">Set the schedule for automatically deleting old PM records. This cycle runs when the admin logs in.</p>
                                      <div class="flex items-center space-x-4">
                                          <label for="interval-duration" class="font-semibold">Interval:</label>
                                          <select id="interval-duration" class="p-2 border rounded-lg">
                                              <option value="daily">Daily</option>
                                              <option value="weekly" selected>Weekly</option>
                                              <option value="monthly">Monthly</option>
                                          </select>
                                      </div>
                                      <div class="grid grid-cols-1 gap-4">
                                          <div>
                                              <label for="start-date" class="font-semibold">Cycle Start Date:</label>
                                              <input type="date" id="start-date" class="w-full p-2 border rounded-lg">
                                          </div>
                                          <div class="bg-gray-100 p-2 rounded-lg text-center">
                                              <p class="text-sm font-medium">Next cycle ends on: <strong id="end-date-display" class="text-blue-600"></strong></p>
                                          </div>
                                      </div>
                                      <div class="flex flex-wrap gap-4">
                                          <button onclick="runCycleManually()" class="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition">Run Archive Cycle Now</button>
                                          <button onclick="confirmClearAllData()" class="bg-red-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-900 transition">Clear ALL History</button>
                                      </div>
                                  </div>

                                  <div id="user-management" class="space-y-4 border p-4 rounded-lg bg-white">
                                      <h3 class="font-semibold text-lg text-gray-700">Manage Users</h3>
                                      <div id="user-editor-container" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                          <!-- User editor will be populated here -->
                                      </div>
                                      <button onclick="saveUsers()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Users</button>
                                  </div>
                              </div>
                         </div>
                     </div>
                  </div>
             </main>
              <footer class="bg-gray-200 text-center p-4 z-10">
                  <p class="text-sm text-gray-600">Design by: Eng.Abdallah Dmour</p>
              </footer>
        </div>

        <div id="equipment-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-11/12 max-w-3xl">
                <h2 class="text-2xl font-bold mb-4" id="equipment-modal-title">Select Equipment</h2>
                <div class="mb-4">
                    <input type="text" id="tag-search" class="w-full p-3 border rounded-lg" placeholder="Search by TAG number...">
                </div>
                <div class="h-64 overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TAG Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment Description</th>
                            </tr>
                        </thead>
                        <tbody id="equipment-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Equipment table will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeEquipmentModal()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- NEW INTERACTIVE PM MODAL -->
        <div id="pm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center overflow-y-auto p-4 z-50">
            <div class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-2xl w-full max-w-4xl relative">
                
                <!-- HEADER: Title and OFF MODE Toggle -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-white">Motor Inspection</h2>
                        <p class="text-sm md:text-lg text-gray-400">TAG: <span id="pm-tag-number" class="font-semibold text-blue-400"></span></p>
                    </div>
                    <button id="pm-off-mode-button" onclick="togglePmOffMode()" class="bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition hover:bg-gray-500">
                        OFF MODE
                    </button>
                </div>

                <!-- WARNING MESSAGE (for duplicate PM) -->
                <div id="pm-warning-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                </div>

                <!-- MAIN INTERACTIVE AREA -->
                <div id="pm-interactive-container" class="relative w-full max-w-3xl mx-auto rounded-lg overflow-hidden">
                    <!-- Animated Circles Background -->
                    <ul class="circles" style="z-index: 10;">
                        <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
                    </ul>
                    
                    <!-- Base Motor Image -->
                    <img src="Motor based.png" alt="Motor Diagram" class="w-full h-auto relative" style="z-index: 20;"
                         onerror="this.src='https://placehold.co/1024x768/374151/E2E8F0?text=Motor+Image+Not+Found%0A(Motor%20based.png)'">

                    <!-- Inspection Icons (Absolutely Positioned) -->
                    
                    <!-- 1. Status -->
                    <button id="pm-icon-status" onclick="openInspectionPoint('status')" class="pm-icon-button absolute top-1/2 left-4 md:left-10 transform -translate-y-1/2">
                        <svg class="w-6 h-6 md:w-8 md:h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="19" x2="8" y2="21"></line><line x1="8" y1="13" x2="8" y2="15"></line><line x1="16" y1="19" x2="16" y2="21"></line><line x1="16" y1="13" x2="16" y2="15"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="12" y1="15" x2="12" y2="17"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>
                        <span class="pm-icon-label">Status</span>
                    </button>

                    <!-- 2. Sound -->
                    <button id="pm-icon-sound" onclick="openInspectionPoint('sound')" class="pm-icon-button absolute top-1/4 left-1/3 md:left-1/4 transform -translate-x-1/2 -translate-y-1/2">
                        <svg class="w-6 h-6 md:w-8 md:h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <span class="pm-icon-label">Sound</span>
                    </button>

                    <!-- 3. Vibration -->
                    <button id="pm-icon-vibration" onclick="openInspectionPoint('vibration')" class="pm-icon-button absolute top-1/3 right-1/4 md:right-1/3 transform translate-x-1/2 -translate-y-1/2">
                        <svg class="w-6 h-6 md:w-8 md:h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        <span class="pm-icon-label">Vibration</span>
                    </button>

                    <!-- 4. Temp -->
                    <button id="pm-icon-temp" onclick="openInspectionPoint('temp')" class="pm-icon-button absolute bottom-1/4 right-8 md:right-20 transform translate-x-1/2 translate-y-1/2">
                        <svg class="w-6 h-6 md:w-8 md:h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                        <span class="pm-icon-label">Temp</span>
                    </button>
                    
                    <!-- 5. Shelter -->
                    <button id="pm-icon-shelter" onclick="openInspectionPoint('shelter')" class="pm-icon-button absolute bottom-1/4 left-1/4 md:left-1/3 transform -translate-x-1/2 translate-y-1/2">
                        <svg class="w-6 h-6 md:w-8 md:h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7"></path></svg>
                        <span class="pm-icon-label">Shelter</span>
                    </button>
                </div>
                
                <!-- "Smart" Note Container - Starts Hidden -->
                <div id="pm-note-container" class="hidden mt-6">
                    <label for="note" class="font-semibold text-lg text-white">Note (Recommended for "Error" / "Dirty" / "Not")</label>
                    <textarea id="note" class="w-full mt-2 p-3 border rounded-lg h-24 bg-gray-700 text-white border-gray-600" placeholder="Please describe the issue(s)..."></textarea>
                </div>

                <!-- FOOTER: Cancel and Submit Buttons -->
                <div class="mt-8 flex justify-between">
                    <button onclick="closePmModal()" class="bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600 transition">
                        Cancel
                    </button>
                    <button onclick="submitPmTask()" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition">
                        Submit Inspection Data
                    </button>
                </div>

            </div>

            <!-- POPUP for Questions -->
            <div id="pm-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
                <div id="pm-popup-content" class="bg-gray-700 p-6 rounded-2xl shadow-xl w-full max-w-md">
                    <!-- Content will be dynamically injected here by JavaScript -->
                </div>
            </div>
        </div>
        
        <div id="alert-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[100]">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
                <h2 id="alert-title" class="text-xl font-bold mb-4">Alert</h2>
                <p id="alert-message" class="text-gray-700 mb-6"></p>
                <button onclick="closeAlertModal()" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">OK</button>
            </div>
        </div>

        <div id="confirm-clear-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[100]">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
                <h2 class="text-xl font-bold mb-4 text-red-600">Confirm Action</h2>
                <p id="confirm-clear-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-clear-button-yes" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Yes</button>
                    <button onclick="closeConfirmClearModal()" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Note Confirmation Modal -->
        <div id="confirm-note-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[100]">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
                <h2 class="text-xl font-bold mb-4 text-yellow-600">No Note Added</h2>
                <p class="text-gray-700 mb-6">You have an "Error" status but have not left a note. Are you sure you want to continue?</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="continueSubmitPmTask()" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Yes, Continue</button>
                    <button onclick="closeConfirmNoteModal()" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <div id="grease-search-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-11/12 max-w-3xl">
            <h2 class="text-2xl font-bold mb-4">Search for Motor TAG</h2>
            <div class="mb-4">
                <input type="text" id="grease-tag-search" class="w-full p-3 border rounded-lg" placeholder="Search any TAG number...">
            </div>
            <div class="h-64 overflow-y-auto border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TAG Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment Description</th>
                        </tr>
                    </thead>
                    <tbody id="grease-search-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Grease search table will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="document.getElementById('grease-search-modal').classList.add('hidden')" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <div id="grease-task-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-start justify-center overflow-y-auto py-12 z-50">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-11/12 max-w-lg">
            <h2 class="text-2xl font-bold mb-2">Motor Grease for <span id="grease-tag-number" class="text-blue-600"></span></h2>
            <p class="text-lg text-gray-600 mb-6" id="grease-equipment-description"></p>
            
            <div class="space-y-6">
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <input id="front-bearing-available" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="front-bearing-available" class="ml-3 block font-semibold text-lg text-gray-900">Front Bearing Available?</label>
                    </div>
                    <div id="front-bearing-condition-block" class="hidden mt-4 pl-8">
                        <label class="font-semibold text-md">Condition:</label>
                        <div class="mt-2">
                            <input type="radio" name="front-bearing-condition" value="OK" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 mr-4">OK</span>
                            <input type="radio" name="front-bearing-condition" value="Error" class="form-radio h-5 w-5 text-red-600"><span class="ml-2">Error</span>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <input id="rear-bearing-available" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="rear-bearing-available" class="ml-3 block font-semibold text-lg text-gray-900">Rear Bearing Available?</label>
                    </div>
                    <div id="rear-bearing-condition-block" class="hidden mt-4 pl-8">
                        <label class="font-semibold text-md">Condition:</label>
                        <div class="mt-2">
                            <input type="radio" name="rear-bearing-condition" value="OK" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 mr-4">OK</span>
                            <input type="radio" name="rear-bearing-condition" value="Error" class="form-radio h-5 w-5 text-red-600"><span class="ml-2">Error</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="grease-amount" class="font-semibold text-lg">Total Grease Amount (grams)</label>
                    <input type="number" id="grease-amount" class="w-full mt-2 p-3 border rounded-lg" placeholder="e.g., 50">
                </div>

                <div>
                    <label for="grease-note" class="font-semibold text-lg">Note</label>
                    <textarea id="grease-note" class="w-full mt-2 p-3 border rounded-lg h-24" placeholder="Add extra information here..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeGreaseTaskModal()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                <button onclick="submitGreaseTask()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Greasing Finished</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, Timestamp, writeBatch, doc, setDoc, getDoc, updateDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyA6g7ovAKrplYS0x_SNag8SUifclz8J4uI",
        authDomain: "hlp-pm-electric.firebaseapp.com",
        projectId: "hlp-pm-electric",
        storageBucket: "hlp-pm-electric.firebasestorage.app",
        messagingSenderId: "475757068157",
        appId: "1:475757068157:web:3d5dd04d0164d94f6a1614",
        measurementId: "G-2S0LCM62GH"
    };

    // --- INITIALIZE FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentZone = null;
    let selectedEquipment = null;
    let equipmentData = { HLP: [], SCREEN: [], COMPACTION: [] };
    let allTasks = [];
    let allGreaseTasks = [];
    let unsubscribePmTasks = null;
    let unsubscribeGreaseTasks = null; // Added this
    let unsubscribeUserSettings = null;
    
    let pmState = {}; // Holds data: { status: 'Clean', sound: 'Normal', ... }
    let isOfflineMode = false;
    let activeInspectionPoint = null; // 'status', 'sound', etc.
    let submitContinuation = null; // Function to run after note confirmation


    // NEW: Default user settings from user list.csv
    const defaultUserSettings = {
        users: [
            { id: 'user1', name: 'Eng. Osama Samirat', password: '7454', color: 'bg-blue-600', hover: 'hover:bg-blue-700', allowedZones: ['HLP', 'SCREEN', 'COMPACTION', 'Motor Grease'] },
            { id: 'user2', name: 'Eng. Saliba Madanat', password: '15486', color: 'bg-teal-600', hover: 'hover:bg-teal-700', allowedZones: ['HLP', 'Motor Grease'] },
            { id: 'user3', name: 'Abdullah Mansour', password: '6453', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', allowedZones: ['SCREEN', 'COMPACTION', 'Motor Grease'] },
            { id: 'user4', name: 'Khaled Qawabaa', password: '7526', color: 'bg-slate-600', hover: 'hover:bg-slate-700', allowedZones: [] },
            { id: 'user5', name: 'Muhammad Zanoun', password: '15515', color: 'bg-blue-600', hover: 'hover:bg-blue-700', allowedZones: ['HLP'] },
            { id: 'user6', name: "Mutasim Ala'a Al-Din", password: '15529', color: 'bg-teal-600', hover: 'hover:bg-teal-700', allowedZones: ['SCREEN'] },
            { id: 'user7', name: 'Muhammad Qatawneh', password: '6432', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', allowedZones: ['COMPACTION'] },
            { id: 'user8', name: 'Anwar Souqi', password: '6325', color: 'bg-slate-600', hover: 'hover:bg-slate-700', allowedZones: ['Motor Grease'] },
            { id: 'user9', name: 'Ibrahim Sharaida', password: '7647', color: 'bg-blue-600', hover: 'hover:bg-blue-700', allowedZones: ['HLP', 'SCREEN'] },
            { id: 'user10', name: 'Isaac Daqas', password: '4853', color: 'bg-teal-600', hover: 'hover:bg-teal-700', allowedZones: ['SCREEN', 'COMPACTION'] },
            { id: 'user11', name: 'Ali Sharshir', password: '7170', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', allowedZones: ['HLP', 'COMPACTION'] },
            { id: 'user12', name: 'Omar Abu Taqseerah', password: '15534', color: 'bg-slate-600', hover: 'hover:bg-slate-700', allowedZones: ['HLP', 'Motor Grease'] },
            { id: 'user13', name: 'Wajdi Kaakouri', password: '4888', color: 'bg-blue-600', hover: 'hover:bg-blue-700', allowedZones: ['SCREEN', 'Motor Grease'] },
            { id: 'user14', name: 'Khaled Abu Amr', password: '7658', color: 'bg-teal-600', hover: 'hover:bg-teal-700', allowedZones: ['COMPACTION', 'Motor Grease'] },
            { id: 'user15', name: 'Muhammad Adel', password: '7177', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', allowedZones: ['HLP', 'SCREEN', 'COMPACTION'] },
            { id: 'user16', name: 'Osama Al-Lemon', password: '7202', color: 'bg-slate-600', hover: 'hover:bg-slate-700', allowedZones: ['HLP', 'SCREEN', 'Motor Grease'] },
            { id: 'user17', name: 'Youssef Abu Odeh', password: '15530', color: 'bg-blue-600', hover: 'hover:bg-blue-700', allowedZones: ['HLP', 'COMPACTION', 'Motor Grease'] },
            { id: 'user18', name: 'Ahmed Daqs', password: '1111', color: 'bg-teal-600', hover: 'hover:bg-teal-700', allowedZones: ['SCREEN', 'COMPACTION', 'Motor Grease'] },
            { id: 'user19', name: 'Abdullah Mashaala', password: '1112', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', allowedZones: ['HLP', 'SCREEN', 'COMPACTION', 'Motor Grease'] },
            { id: 'user20', name: 'General user', password: '', color: 'bg-slate-600', hover: 'hover:bg-slate-700', allowedZones: ['HLP', 'SCREEN', 'COMPACTION', 'Motor Grease'] }
        ],
        archiveSchedule: {
            start: null,
            interval: 'weekly'
        }
    };
    let userSettings = { ...defaultUserSettings };

    // --- EMBEDDED CSV DATA ---
    const hlpCsvData = `TAG number,Equipment Description
13-29-060,DRYER FEED CONVEYOR BELT #60
13-29-061,DRYER FEED CONVEYOR BELT #61
13-29-062,DRYER FEED CONVEYOR BELT #62
13-29-063,DRYER FEED CONVEYOR BELT #63
13-29-064,DRYER FEED CONVEYOR BELT #64
13-29-065,DRYER FEED CONVEYOR BELT #65`;

    const screenCsvData = `TAG number,Equipment Description
14-75-800 M,DIVERTER UNIT
14-75-801 M,DIVERTER UNIT
14-75-802 M,DIVERTER UNIT
14-75-803 M,DIVERTER UNIT`;

    const compactionCsvData = `TAG number,Equipment Description
16-85-600M2,de-dusting bag house filter throttle valve actuator
16-85-601M2,de-dusting bag house filter throttle valve actuator
16-85-602M2,de-dusting bag house filter throttle valve actuator`;

    // --- UI HELPER FUNCTIONS ---
    const showLoader = () => document.getElementById('loader-overlay').classList.remove('hidden');
    const hideLoader = () => document.getElementById('loader-overlay').classList.add('hidden');
    
    // --- LOCAL STORAGE HELPERS FOR "REMEMBER ME" ---
    function saveUserCredentials(userId, password) {
        const credentials = { password: password };
        localStorage.setItem(`pm-user-${userId}`, JSON.stringify(credentials));
    }

    function getSavedUserCredentials(userId) {
        const saved = localStorage.getItem(`pm-user-${userId}`);
        return saved ? JSON.parse(saved) : null;
    }

    function clearUserCredentials(userId) {
        localStorage.removeItem(`pm-user-${userId}`);
    }

    // --- DATA LOADING ---
    function loadEquipmentData() {
        const dataMap = { HLP: hlpCsvData, SCREEN: screenCsvData, COMPACTION: compactionCsvData };
        for (const zone in dataMap) {
            try {
                const text = dataMap[zone];
                const lines = text.split('\n').slice(1);
                equipmentData[zone] = lines.map(line => {
                    const [tag, ...descriptionParts] = line.split(',');
                    const description = descriptionParts.join(',').trim();
                    return { tag: tag?.trim(), description: description.replace(/"/g, '') };
                }).filter(e => e.tag && e.description);
            } catch (error) {
                console.error(`Error parsing data for ${zone}:`, error);
            }
        }
    }

    // --- USER AND SCHEDULE SETTINGS (FIREBASE-BACKED) ---
    async function loadSettings() {
        showLoader();
        const settingsDocRef = doc(db, "app_settings", "global_settings");
        try {
            const docSnap = await getDoc(settingsDocRef);
            if (docSnap.exists()) {
                const firebaseSettings = docSnap.data();
                
                // NEW MERGE LOGIC:
                // Use default users as the base, preserving names and passwords from CSV.
                let mergedUsers = defaultUserSettings.users.map(defaultUser => {
                    // Find the corresponding user saved in Firebase (if any)
                    const firebaseUser = firebaseSettings.users?.find(fu => fu.id === defaultUser.id);
                    
                    if (firebaseUser) {
                        // User exists in Firebase. Use default name/password, but saved permissions.
                        return {
                            ...defaultUser, // Default id, name, password, color
                            allowedZones: firebaseUser.allowedZones || [] // Saved permissions
                        };
                    } else {
                        // User is new (not in Firebase). Use default settings.
                        return defaultUser;
                    }
                });

                // Ensure we have exactly 20 users, in case Firebase has fewer/more
                if (mergedUsers.length !== 20) {
                     // If something is wrong, just reset to defaults
                    mergedUsers = defaultUserSettings.users;
                }

                userSettings.users = mergedUsers;
                userSettings.archiveSchedule = firebaseSettings.archiveSchedule || defaultUserSettings.archiveSchedule;
                
                if (!userSettings.archiveSchedule.start) {
                    userSettings.archiveSchedule.start = new Date().toISOString().split('T')[0];
                    await saveSettings(); // Save the updated start date
                }
                
                // Force save the merged user list back to Firebase to sync names/passwords
                await saveSettings(); 
                
            } else {
                console.warn("No 'global_settings' document found. Creating with defaults.");
                defaultUserSettings.archiveSchedule.start = new Date().toISOString().split('T')[0];
                userSettings = { ...defaultUserSettings };
                await setDoc(settingsDocRef, userSettings);
            }
            // renderUserButtons() is removed
        } catch (error) {
            console.error("Error loading settings:", error);
            showAlert('Failed to load application settings.', 'Error');
        } finally {
            hideLoader();
        }
    }

    async function saveSettings() {
        userSettings.archiveSchedule.start = document.getElementById('start-date')?.value || userSettings.archiveSchedule.start;
        userSettings.archiveSchedule.interval = document.getElementById('interval-duration')?.value || userSettings.archiveSchedule.interval;
        const settingsDocRef = doc(db, "app_settings", "global_settings");
        try {
            await setDoc(settingsDocRef, userSettings);
        } catch (error) {
            console.error("Error saving settings:", error);
            showAlert('Failed to save settings.', 'Error');
        }
    }

    window.saveUsers = async () => {
        showLoader();
        
        // 1. Read all new values from the DOM
        userSettings.users.forEach((user) => {
            const nameInput = document.getElementById(`user-name-edit-${user.id}`);
            const passwordInput = document.getElementById(`user-password-edit-${user.id}`);
            if (nameInput) user.name = nameInput.value;
            if (passwordInput) user.password = passwordInput.value;
            
            const selectedZones = [];
            document.querySelectorAll(`.zone-checkbox[data-user-id="${user.id}"]:checked`).forEach(checkbox => {
                selectedZones.push(checkbox.value);
            });
            user.allowedZones = selectedZones;
        });

        // 2. NEW: Validate for duplicate passwords
        const passwordSet = new Set();
        let duplicatePassword = null;
        for (const user of userSettings.users) {
            // Allow one blank password for "General user"
            if (user.password === "") continue; 
            
            if (passwordSet.has(user.password)) {
                duplicatePassword = user.password;
                break;
            }
            passwordSet.add(user.password);
        }

        // 3. If duplicate found, show interrupt alert and stop
        if (duplicatePassword) {
            hideLoader();
            showAlert(`Duplicate password found: "${duplicatePassword}". Please ensure all passwords are unique.`, "Save Error");
            return; // Stop the function before saving
        }

        // 4. If no duplicates, proceed with saving
        await saveSettings();
        // renderUserButtons() is removed
        hideLoader();
        showAlert('User settings saved!', 'Success');
    };

    function renderUserEditor() {
        const container = document.getElementById('user-editor-container');
        if(!container) return;
        container.innerHTML = '';
        const allZones = ['HLP', 'SCREEN', 'COMPACTION', 'Motor Grease'];
        userSettings.users.forEach((user, index) => {
            const div = document.createElement('div');
            div.className = 'p-3 border rounded-lg bg-gray-50';
            let zoneCheckboxesHTML = allZones.map(zone => `
                <label class="inline-flex items-center mr-4">
                    <input type="checkbox" value="${zone}" ${user.allowedZones.includes(zone) ? 'checked' : ''} class="form-checkbox h-5 w-5 text-blue-600 zone-checkbox" data-user-id="${user.id}">
                    <span class="ml-2">${zone}</span>
                </label>`).join('');
            div.innerHTML = `
                <label for="user-name-edit-${user.id}" class="font-semibold text-sm">${user.id}:</label>
                <input type="text" id="user-name-edit-${user.id}" value="${user.name}" class="w-full p-2 border rounded-lg mt-1 mb-2">
                <label for="user-password-edit-${user.id}" class="font-semibold text-sm">Password:</label>
                <input type="text" id="user-password-edit-${user.id}" value="${user.password}" class="w-full p-2 border rounded-lg mt-1 mb-2">
                <label class="font-semibold text-sm mt-2 block">Allowed Zones:</label>
                <div class="flex flex-wrap gap-2 mt-1">${zoneCheckboxesHTML}</div>
            `;
            container.appendChild(div);
        });
    }
    
    // This function is no longer used to render buttons, but is kept for compatibility
    function renderUserButtons() {
       // No longer needed
    }

    // --- LOGIN/LOGOUT & UI FLOW ---
    
    // This function is no longer used, but we keep the "remember me" logic
    window.showUserPasswordPrompt = (user) => {
        const savedCreds = getSavedUserCredentials(user.id);
        const latestUser = userSettings.users.find(u => u.id === user.id);

        if (savedCreds && latestUser && savedCreds.password === latestUser.password) {
            showLoader();
            setTimeout(() => {
                showUserDashboard(latestUser.name);
                hideLoader();
            }, 200);
            return;
        }
        
        if(savedCreds) {
             clearUserCredentials(user.id);
        }
    };

    // This function is no longer used
    window.closeUserPasswordModal = () => {};

    window.loginUserWithPassword = () => {
        const password = document.getElementById('user-password-input').value;
        if (!password) {
            showAlert('Please enter a password.');
            return;
        }

        const foundUser = userSettings.users.find(u => u.password === password);
        
        if (foundUser) {
            // We don't use "remember me" in this flow, but we could add it
            showUserDashboard(foundUser.name);
        } else {
            showAlert('Incorrect password.');
            document.getElementById('user-password-input').value = '';
            document.getElementById('user-password-input').focus();
        }
    };

    function showUserDashboard(userName) {
        currentUser = userName;
        document.getElementById('current-user').innerText = `User: ${currentUser}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('user-interface').classList.remove('hidden');

        const loggedInUser = userSettings.users.find(u => u.name === currentUser);
        const userAllowedZones = loggedInUser ? loggedInUser.allowedZones : [];

        // --- PM Zone Buttons ---
        const hlpButton = document.querySelector('button[onclick="selectZone(\'HLP\')"]');
        const screenButton = document.querySelector('button[onclick="selectZone(\'SCREEN\')"]');
        const compactionButton = document.querySelector('button[onclick="selectZone(\'COMPACTION\')"]');

        if (hlpButton) hlpButton.style.display = userAllowedZones.includes('HLP') ? '' : 'none';
        if (screenButton) screenButton.style.display = userAllowedZones.includes('SCREEN') ? '' : 'none';
        if (compactionButton) compactionButton.style.display = userAllowedZones.includes('COMPACTION') ? '' : 'none';
        
        // --- Motor Grease Card ---
        const greaseTaskCard = document.getElementById('grease-task-card');
        if (greaseTaskCard) {
            greaseTaskCard.style.display = userAllowedZones.includes('Motor Grease') ? 'flex' : 'none';
        }

        listenForTasks();
    }

    window.showAdminLogin = () => {
        document.getElementById('user-login').classList.add('hidden');
        document.getElementById('admin-login').classList.remove('hidden');
        document.getElementById('admin-password').focus();
    };

    window.showUserSelection = () => {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('user-login').classList.remove('hidden');
        document.getElementById('user-password-input').focus();
    };

    window.loginAdmin = async () => {
        showLoader();
        const password = document.getElementById('admin-password').value;
        if (password === 'Karak@2025') {
            const rememberMe = document.getElementById('admin-remember-me').checked;
            if (rememberMe) {
                localStorage.setItem('admin-remembered', 'true');
            } else {
                localStorage.removeItem('admin-remembered');
            }
            
            currentUser = 'Admin';
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-interface').classList.remove('hidden');
            initializeAdminUI();
            await checkAndRunArchiveCycle();
            listenForTasks();
            listenForUserSettingsChanges();
            listenForGreaseTasks();
        } else {
            showAlert('Incorrect password.');
            document.getElementById('admin-password').value = '';
        }
        hideLoader();
    };
    
    window.logout = () => {
        currentUser = null;
        if (unsubscribePmTasks) unsubscribePmTasks();
        if (unsubscribeGreaseTasks) unsubscribeGreaseTasks();
        if (unsubscribeUserSettings) unsubscribeUserSettings();
        
        localStorage.removeItem('admin-remembered');
        
        document.getElementById('user-interface').classList.add('hidden');
        document.getElementById('admin-interface').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('admin-password').value = '';
        document.getElementById('user-password-input').value = '';
        showUserSelection(); // Go back to user password input
    };

    // --- ADMIN UI & AUTOMATED DATE LOGIC ---
    function initializeAdminUI() {
        renderUserEditor();
        setupAdminFilters();

        const startDateInput = document.getElementById('start-date');
        const intervalSelect = document.getElementById('interval-duration');
        const { start, interval } = userSettings.archiveSchedule;

        if (start && interval) {
            startDateInput.value = start;
            intervalSelect.value = interval;
        } else {
            startDateInput.value = new Date().toISOString().split('T')[0];
            intervalSelect.value = 'weekly';
        }
        updateArchiveScheduleDisplay();
        intervalSelect.addEventListener('change', updateArchiveScheduleDisplay);
        startDateInput.addEventListener('change', updateArchiveScheduleDisplay);
    }

    function updateArchiveScheduleDisplay() {
        const startDateInput = document.getElementById('start-date');
        const intervalSelect = document.getElementById('interval-duration');
        if (!startDateInput || !intervalSelect) return;
        let startDate = new Date(startDateInput.value + "T00:00:00");
        if (isNaN(startDate.getTime())) return;
        let endDate = calculateEndDate(startDate, intervalSelect.value);
        document.getElementById('end-date-display').textContent = endDate.toLocaleDateString();
    }

    function calculateEndDate(startDate, interval) {
        let endDate = new Date(startDate);
        if (interval === 'daily') {
            endDate.setDate(startDate.getDate());
        } else if (interval === 'weekly') {
            endDate.setDate(startDate.getDate() + 6);
        } else if (interval === 'monthly') {
            endDate.setMonth(startDate.getMonth() + 1);
            endDate.setDate(endDate.getDate() - 1);
        }
        return endDate;
    }

    function listenForUserSettingsChanges() {
        const settingsDocRef = doc(db, "app_settings", "global_settings");
        unsubscribeUserSettings = onSnapshot(settingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const firebaseSettings = docSnap.data();

                // Use default users as the base
                let mergedUsers = defaultUserSettings.users.map(defaultUser => {
                    // Find the corresponding user saved in Firebase (if any)
                    const firebaseUser = firebaseSettings.users?.find(fu => fu.id === defaultUser.id);
                    
                    if (firebaseUser) {
                        // User exists in Firebase. Use default name/password, but saved permissions.
                        return {
                            ...defaultUser,
                            allowedZones: firebaseUser.allowedZones || defaultUser.allowedZones
                        };
                    } else {
                        // User is new (not in Firebase). Use default settings.
                        return defaultUser;
                    }
                });

                userSettings.users = mergedUsers;
                userSettings.archiveSchedule = firebaseSettings.archiveSchedule || defaultUserSettings.archiveSchedule;

                if (currentUser === 'Admin') {
                    renderUserEditor();
                }
                // renderUserButtons() removed
                updateArchiveScheduleDisplay();
                if (currentUser && currentUser !== 'Admin') {
                    showUserDashboard(currentUser);
                }
            }
        }, (error) => {
            console.error("Firebase settings snapshot error: ", error);
            showAlert("Error syncing settings from database.", "Database Error");
        });
    }

    // --- MODALS AND ALERTS ---
    window.showAlert = (message, title = 'Alert') => {
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-message').innerText = message;
        document.getElementById('alert-modal').classList.remove('hidden');
    };

    window.closeAlertModal = () => document.getElementById('alert-modal').classList.add('hidden');
    
    window.closeConfirmNoteModal = () => {
        document.getElementById('confirm-note-modal').classList.add('hidden');
        submitContinuation = null;
    }

    window.selectZone = (zone) => {
        if (currentUser !== 'Admin') {
            const loggedInUser = userSettings.users.find(u => u.name === currentUser);
            if (!loggedInUser || !loggedInUser.allowedZones.includes(zone)) {
                showAlert(`You do not have permission to access the ${zone} zone.`, 'Permission Denied');
                return;
            }
        }
        
        currentZone = zone;
        document.getElementById('equipment-modal-title').innerText = `Select Equipment for ${zone}`;
        populateEquipmentTable(zone);
        document.getElementById('equipment-modal').classList.remove('hidden');
        document.getElementById('tag-search').focus();
    };

    window.closeEquipmentModal = () => {
        document.getElementById('equipment-modal').classList.add('hidden');
        document.getElementById('tag-search').value = '';
    };

    window.selectEquipment = async (tag, description) => {
        selectedEquipment = { tag, description };
        const warningDiv = document.getElementById('pm-warning-message');

        // Clear previous warning
        warningDiv.classList.add('hidden');
        warningDiv.innerHTML = '';
        
        document.getElementById('pm-tag-number').innerText = tag;
        closeEquipmentModal();
        
        // Reset the new modal's state every time it's opened
        resetPmModalState(); 
        
        document.getElementById('pm-modal').classList.remove('hidden');
    };

    window.closePmModal = () => {
        document.getElementById('pm-modal').classList.add('hidden');
        resetPmModalState(); // Use the reset function
        closePopup(); // Ensure popup is also closed
    };

    function populateEquipmentTable(zone) {
        const tableBody = document.getElementById('equipment-table-body');
        const searchInput = document.getElementById('tag-search');
        const renderTable = (filter = '') => {
            tableBody.innerHTML = '';
            const filteredData = equipmentData[zone].filter(eq =>
                eq.tag.toLowerCase().includes(filter.toLowerCase()) ||
                eq.description.toLowerCase().includes(filter.toLowerCase())
            );
            filteredData.forEach(({ tag, description }) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#" onclick="event.preventDefault(); selectEquipment('${tag}', \`${description.replace(/'/g, "\\'")}\`)" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">${tag}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${description}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        searchInput.onkeyup = () => renderTable(searchInput.value);
        renderTable();
    }
    
    // --- NEW FUNCTIONS FOR MOTOR GREASING TASK ---

    let selectedGreaseEquipment = null;

    function populateGreaseSearchTable(equipmentList) {
        const tableBody = document.getElementById('grease-search-table-body');
        const searchInput = document.getElementById('grease-tag-search');
        
        const renderTable = (filter = '') => {
            tableBody.innerHTML = '';
            const filteredData = equipmentList.filter(eq =>
                eq.tag.toLowerCase().includes(filter.toLowerCase()) ||
                eq.description.toLowerCase().includes(filter.toLowerCase())
            );
            filteredData.forEach(({ tag, description }) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#" onclick="event.preventDefault(); selectGreaseEquipment('${tag}', \`${description.replace(/'/g, "\\'")}\`)" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">${tag}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${description}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        searchInput.onkeyup = () => renderTable(searchInput.value);
        renderTable();
    }

    window.showGreaseSearch = () => {
        const allEquipment = [...equipmentData.HLP, ...equipmentData.SCREEN, ...equipmentData.COMPACTION];
        populateGreaseSearchTable(allEquipment);
        document.getElementById('grease-search-modal').classList.remove('hidden');
        document.getElementById('grease-tag-search').focus();
    };

    window.selectGreaseEquipment = (tag, description) => {
        selectedGreaseEquipment = { tag, description };
        document.getElementById('grease-tag-number').innerText = tag;
        document.getElementById('grease-equipment-description').innerText = description;
        document.getElementById('grease-search-modal').classList.add('hidden');
        document.getElementById('grease-task-modal').classList.remove('hidden');
    };

    window.closeGreaseTaskModal = () => {
        document.getElementById('grease-task-modal').classList.add('hidden');
        // Reset form
        document.getElementById('front-bearing-available').checked = false;
        document.getElementById('rear-bearing-available').checked = false;
        document.getElementById('front-bearing-condition-block').classList.add('hidden');
        document.getElementById('rear-bearing-condition-block').classList.add('hidden');
        document.getElementById('grease-amount').value = '';
        document.getElementById('grease-note').value = '';
        selectedGreaseEquipment = null;
    };

    window.submitGreaseTask = async () => {
        const frontBearingAvailable = document.getElementById('front-bearing-available').checked;
        const rearBearingAvailable = document.getElementById('rear-bearing-available').checked;

        const taskData = {
            user: currentUser,
            tag: selectedGreaseEquipment.tag,
            description: selectedGreaseEquipment.description,
            frontBearingAvailable: frontBearingAvailable,
            frontBearingCondition: frontBearingAvailable ? (document.querySelector('input[name="front-bearing-condition"]:checked')?.value || 'N/A') : 'Not Available',
            rearBearingAvailable: rearBearingAvailable,
            rearBearingCondition: rearBearingAvailable ? (document.querySelector('input[name="rear-bearing-condition"]:checked')?.value || 'N/A') : 'Not Available',
            greaseAmount: document.getElementById('grease-amount').value,
            note: document.getElementById('grease-note').value,
            timestamp: serverTimestamp(),
        };

        try {
            await addDoc(collection(db, "grease_tasks"), taskData);
            showAlert('Greasing Task Saved Successfully!', 'Success');
            closeGreaseTaskModal();
        } catch (error) {
            console.error("Error adding greasing task: ", error);
            showAlert('Failed to save greasing task.', 'Error');
        }
    };

    // --- NEW PM MODAL LOGIC ---

    function resetPmModalState() {
        pmState = {};
        isOfflineMode = false;
        activeInspectionPoint = null;
        document.getElementById('note').value = '';
        document.getElementById('pm-note-container').classList.add('hidden');
        updateIconStates();
        const offModeButton = document.getElementById('pm-off-mode-button');
        offModeButton.classList.remove('bg-red-600', 'text-white');
        offModeButton.classList.add('bg-gray-600', 'text-white');
        offModeButton.innerText = "OFF MODE";
    }

    window.togglePmOffMode = () => {
        isOfflineMode = !isOfflineMode;
        const offModeButton = document.getElementById('pm-off-mode-button');
        if (isOfflineMode) {
            offModeButton.classList.remove('bg-gray-600');
            offModeButton.classList.add('bg-red-600');
            offModeButton.innerText = "OFFLINE";
            // Clear any data that is now disabled
            delete pmState.sound;
            delete pmState.vibration;
            delete pmState.temp;
        } else {
            offModeButton.classList.remove('bg-red-600');
            offModeButton.classList.add('bg-gray-600');
            offModeButton.innerText = "OFF MODE";
        }
        updateIconStates();
    }

    function updateIconStates() {
        const iconsToDisable = ['sound', 'vibration', 'temp'];
        const allIcons = ['status', 'sound', 'vibration', 'temp', 'shelter'];

        allIcons.forEach(iconName => {
            const iconElement = document.getElementById(`pm-icon-${iconName}`);
            if (!iconElement) return;

            // Reset styles
            iconElement.classList.remove('pending', 'ok', 'error', 'disabled');

            // 1. Check if it should be disabled by OFFLINE mode
            if (isOfflineMode && iconsToDisable.includes(iconName)) {
                iconElement.classList.add('disabled');
            } 
            // 2. Check its data state
            else if (pmState[iconName]) {
                // It has data, check if it's an "error" state
                const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
                const isError = errorStates.includes(pmState[iconName]) || errorStates.includes(pmState[`${iconName}_action`]) || errorStates.includes(pmState[`${iconName}_source`]) || errorStates.includes(pmState['status_dirty_action']) || errorStates.includes(pmState['sound_abnormal_source']);
                if (isError) {
                    iconElement.classList.add('error'); // Completed with error
                } else {
                    iconElement.classList.add('ok'); // Completed OK
                }
            } 
            // 3. It's active and not completed
            else {
                iconElement.classList.add('pending'); // Pending
            }
        });
        checkSmartNote();
    }

    function checkSmartNote() {
        const noteContainer = document.getElementById('pm-note-container');
        const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
        let showError = false;
        for (const key in pmState) {
            if (errorStates.includes(pmState[key])) {
                showError = true;
                break;
            }
        }
        noteContainer.classList.toggle('hidden', !showError);
    }

    window.openInspectionPoint = (pointName) => {
        activeInspectionPoint = pointName;
        renderPopupContent(pointName);
        document.getElementById('pm-popup').classList.remove('hidden');
    }

    window.closePopup = () => {
        document.getElementById('pm-popup').classList.add('hidden');
        activeInspectionPoint = null;
        updateIconStates();
    }

    function renderPopupContent(step) {
        const container = document.getElementById('pm-popup-content');
        let html = '';

        switch (step) {
            case 'status':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Motor Status</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('status', 'Clean')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Clean</button>
                        <button onclick="handlePopupChoice('status', 'Dirty')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Dirty</button>
                    </div>`;
                break;
            case 'status_dirty_action':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Action for "Dirty"</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('status_dirty_action', 'Done')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Done</button>
                        <button onclick="handlePopupChoice('status_dirty_action', 'Not')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Not</button>
                    </div>`;
                break;
            case 'sound':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Sound</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('sound', 'Normal')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Normal</button>
                        <button onclick="handlePopupChoice('sound', 'Abnormal')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Abnormal</button>
                    </div>`;
                break;
            case 'sound_abnormal_source':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">"Abnormal" Sound Source</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="handlePopupChoice('sound_abnormal_source', 'Front Bearing')" class="pm-choice-button bg-blue-100 text-blue-800 border-blue-300 hover:bg-blue-200">Front Bearing</button>
                        <button onclick="handlePopupChoice('sound_abnormal_source', 'Rear Bearing')" class="pm-choice-button bg-blue-100 text-blue-800 border-blue-300 hover:bg-blue-200">Rear Bearing</button>
                        <button onclick="handlePopupChoice('sound_abnormal_source', 'Other')" class="pm-choice-button bg-gray-100 text-gray-800 border-gray-300 hover:bg-gray-200">Other</button>
                    </div>`;
                break;
            case 'vibration':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Vibration</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('vibration', 'Normal')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Normal</button>
                        <button onclick="handlePopupChoice('vibration', 'Abnormal')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Abnormal</button>
                    </div>`;
                break;
            case 'temp':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Temperature</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('temp', 'Normal')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Normal</button>
                        <button onclick="handlePopupChoice('temp', 'Abnormal')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Abnormal</button>
                    </div>`;
                break;
            case 'shelter':
                html = `<h3 class="text-2xl font-bold text-center mb-6 text-white">Shelter</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handlePopupChoice('shelter', 'Exist')" class="pm-choice-button bg-green-100 text-green-800 border-green-300 hover:bg-green-200">Exist</button>
                        <button onclick="handlePopupChoice('shelter', 'Not Exist')" class="pm-choice-button bg-red-100 text-red-800 border-red-300 hover:bg-red-200">Not Exist</button>
                    </div>`;
                break;
        }
        container.innerHTML = html;
    }
    
    window.handlePopupChoice = (step, choice) => {
        // Save the choice
        if (step === 'status_dirty_action') {
            pmState.status_dirty_action = choice;
        } else if (step === 'sound_abnormal_source') {
            pmState.sound_abnormal_source = choice;
        } else {
            pmState[step] = choice;
        }

        // --- Conditional Logic ---
        // 1. If 'Dirty' -> ask for action
        if (step === 'status' && choice === 'Dirty') {
            renderPopupContent('status_dirty_action');
            return; // Don't close popup
        }
        
        // 2. If 'Abnormal' Sound -> ask for source
        if (step === 'sound' && choice === 'Abnormal') {
            renderPopupContent('sound_abnormal_source');
            return; // Don't close popup
        }

        // --- If no more steps for this point, close popup ---
        closePopup();
    }
    
    // --- DATA HANDLING AND SUBMISSION ---
    window.submitPmTask = async () => {
        // --- VALIDATION ---
        const requiredPoints = isOfflineMode ? ['status', 'shelter'] : ['status', 'sound', 'vibration', 'temp', 'shelter'];
        const missingPoints = requiredPoints.filter(point => !pmState[point]);

        if (missingPoints.length > 0) {
            showAlert(`Please complete all required inspection points: ${missingPoints.join(', ')}`, 'Incomplete Data');
            return;
        }
        
        // Check if note is required but empty
        const noteContainer = document.getElementById('pm-note-container');
        const note = document.getElementById('note').value;
        if (!noteContainer.classList.contains('hidden') && !note.trim()) {
            // Show confirmation modal instead of blocking
            document.getElementById('confirm-note-modal').classList.remove('hidden');
            return;
        }
        
        // If validation passes (or no note is needed), continue
        continueSubmitPmTask();
    };
    
    window.continueSubmitPmTask = async () => {
        // Close the note confirmation modal if it was open
        closeConfirmNoteModal();
        showLoader();

        const note = document.getElementById('note').value;
        
        // Build the new task object
        const task = {
            user: currentUser,
            zone: currentZone,
            tag: selectedEquipment.tag,
            description: selectedEquipment.description,
            timestamp: serverTimestamp(),
            resolvedByAdmin: false,
            
            // New detailed data
            inspectionMode: isOfflineMode ? 'Offline' : 'Online',
            status: pmState.status || 'N/A',
            status_dirty_action: pmState.status_dirty_action || 'N/A',
            sound: pmState.sound || 'N/A',
            sound_abnormal_source: pmState.sound_abnormal_source || 'N/A',
            vibration: pmState.vibration || 'N/A',
            temp: pmState.temp || 'N/A',
            shelter: pmState.shelter || 'N/A',
            note: note,
            
            // --- Deprecated Simple Fields (for backwards compatibility) ---
            // We can set a general "status" for the old admin view
            status: (pmState.status === 'Dirty' || pmState.sound === 'Abnormal' || pmState.vibration === 'Abnormal' || pmState.temp === 'Abnormal' || pmState.shelter === 'Not Exist' || pmState.status_dirty_action === 'Not') ? 'Error' : 'OK',
            sound: pmState.sound || 'N/A', // Keep simple sound
            vibration: pmState.vibration || 'N/A', // Keep simple vibration
            heat: pmState.temp || 'N/A', // Map temp to heat
            motor_umbrella: pmState.shelter || 'N/A' // Map shelter to motor_umbrella
        };

        // --- SUBMIT TO FIREBASE ---
        try {
            await addDoc(collection(db, "pm_tasks"), task);
            closePmModal();
            showAlert('PM Task Saved Successfully! Select the next equipment.', 'Success');
            selectZone(currentZone); // Re-open equipment list for the same zone

        } catch (error) {
            console.error("Error adding document: ", error);
            showAlert('Failed to save PM task.', 'Error');
        } finally {
            hideLoader();
        }
    };
    
    window.closeConfirmNoteModal = () => {
        document.getElementById('confirm-note-modal').classList.add('hidden');
    };

    window.markPmTaskAsResolved = async (taskId, currentStatus) => {
        const taskRef = doc(db, "pm_tasks", taskId);
        
        // Check the full task data to determine if it's truly an "Error"
        const docSnap = await getDoc(taskRef);
        if (!docSnap.exists()) {
             showAlert('Task not found.', 'Error');
             return;
        }
        const taskData = docSnap.data();
        
        const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
        let isError = taskData.status === 'Error' || // Old logic
                      errorStates.includes(taskData.status) ||
                      errorStates.includes(taskData.sound) ||
                      errorStates.includes(taskData.vibration) ||
                      errorStates.includes(taskData.temp) ||
                      errorStates.includes(taskData.shelter) ||
                      errorStates.includes(taskData.status_dirty_action) ||
                      errorStates.includes(taskData.sound_abnormal_source);
                      
        if (!isError) {
            showAlert('Only PM tasks with an error can be marked as resolved.', 'Invalid Action');
            return;
        }
        
        document.getElementById('confirm-clear-message').innerHTML = `Are you sure you want to mark this PM task as <strong class="text-green-700">resolved by admin</strong>? This will allow users to perform PM on this equipment again.`;
        const yesButton = document.getElementById('confirm-clear-button-yes');
        yesButton.onclick = async () => {
            closeConfirmClearModal();
            showLoader();
            try {
                await updateDoc(taskRef, { resolvedByAdmin: true });
                showAlert('PM Task marked as resolved successfully!', 'Success');
            } catch (error) {
                console.error("Error marking task as resolved: ", error);
                showAlert('Failed to mark task as resolved.', 'Error');
            } finally {
                hideLoader();
            }
        };
        yesButton.innerText = "Yes, Mark Resolved";
        document.getElementById('confirm-clear-modal').classList.remove('hidden');
    };

    function listenForTasks() {
        if (unsubscribePmTasks) unsubscribePmTasks();
        const q = query(collection(db, "pm_tasks"), orderBy("timestamp", "desc"));
        unsubscribePmTasks = onSnapshot(q, (snapshot) => {
            allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentUser === 'Admin') {
                updateAdminAnalytics(); // Update with new PM tasks
                const textFilter = document.getElementById('history-search-text')?.value || '';
                const dateFilter = document.getElementById('history-search-date')?.value || '';
                displayAdminHistory(textFilter, dateFilter);
                displayAdminLive(allTasks);
            } else if (currentUser) {
                displayRecentActivities(allTasks);
            }
        }, (error) => {
            console.error("Firebase snapshot error for tasks: ", error);
            showAlert("Error connecting to the database for tasks.", "Database Error");
        });
    }

    // --- DISPLAY FUNCTIONS ---
    window.scrollRecentActivities = (amount) => {
        const container = document.getElementById('recent-activities-container');
        container.scrollBy({ top: amount, behavior: 'smooth' });
    };

    function displayRecentActivities(tasks) {
        const container = document.getElementById('recent-activities');
        if (!container) return;
        container.innerHTML = '';
        const userTasks = tasks.filter(task => task.user === currentUser);
        userTasks.slice(0, 20).forEach(task => {
            const card = document.createElement('div');
            
            const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
            let isError = task.status === 'Error' || // Old logic
                          errorStates.includes(task.status) ||
                          errorStates.includes(task.sound) ||
                          errorStates.includes(task.vibration) ||
                          errorStates.includes(task.temp) ||
                          errorStates.includes(task.shelter) ||
                          errorStates.includes(task.status_dirty_action) ||
                          errorStates.includes(task.sound_abnormal_source);
                          
            const borderClass = isError && !task.resolvedByAdmin ? 'border-l-4 border-red-500' : 'border-l-4 border-blue-500';
            const statusIndicator = isError && !task.resolvedByAdmin ? '<span class="text-red-600 font-bold ml-2">(Error - Unresolved)</span>' : '';
            
            card.className = `bg-white p-4 rounded-lg shadow-md ${borderClass}`;
            card.innerHTML = `
                <h3 class="font-bold text-lg">${task.tag}${statusIndicator}</h3>
                <p class="text-gray-600">${task.description}</p>
                <div class="mt-2 text-sm text-gray-500">
                    <span>by <strong>${task.user}</strong> on </span>
                    <span>${task.timestamp ? task.timestamp.toDate().toLocaleString() : 'Just now'}</span>
                </div>`;
            container.appendChild(card);
        });
    }

    function displayAdminLive(tasks) {
        const container = document.getElementById('admin-live-activities');
        if (!container) return;
        container.innerHTML = '';
        tasks.slice(0, 10).forEach(task => {
            
            const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
            let isError = task.status === 'Error' || // Old logic
                          errorStates.includes(task.status) ||
                          errorStates.includes(task.sound) ||
                          errorStates.includes(task.vibration) ||
                          errorStates.includes(task.temp) ||
                          errorStates.includes(task.shelter) ||
                          errorStates.includes(task.status_dirty_action) ||
                          errorStates.includes(task.sound_abnormal_source);
            
            const resolutionStatusText = isError && !task.resolvedByAdmin
                ? `<span class="text-red-600 font-bold">Error (Unresolved)</span>`
                : (task.resolvedByAdmin ? `<span class="text-green-600 font-bold">Resolved by Admin</span>` : `<span class="text-green-600 font-bold">OK</span>`);
            
            const resolveButton = isError && !task.resolvedByAdmin
                ? `<button onclick="markPmTaskAsResolved('${task.id}', '${task.status}')" class="ml-4 bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600 transition">Mark Resolved</button>`
                : '';
                
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow border';
            
            // Build details string
            let details = `<strong>Status:</strong> ${task.status || 'N/A'}`;
            if (task.status_dirty_action && task.status_dirty_action !== 'N/A') details += ` (${task.status_dirty_action})`;
            details += `, <strong>Shelter:</strong> ${task.shelter || 'N/A'}`;
            
            if (task.inspectionMode === 'Offline') {
                 details += `, <strong class="text-gray-500">Sound:</strong> (Offline)`;
                 details += `, <strong class="text-gray-500">Vibration:</strong> (Offline)`;
                 details += `, <strong class="text-gray-500">Temp:</strong> (Offline)`;
            } else {
                details += `, <strong>Sound:</strong> ${task.sound || 'N/A'}`;
                if (task.sound_abnormal_source && task.sound_abnormal_source !== 'N/A') details += ` (${task.sound_abnormal_source})`;
                details += `, <strong>Vibration:</strong> ${task.vibration || 'N/A'}`;
                details += `, <strong>Temp:</strong> ${task.temp || 'N/A'}`;
            }

            card.innerHTML = `
                <h3 class="font-bold text-lg text-blue-700">${task.tag} - ${task.description}</h3>
                <p class="text-gray-700 text-sm">${details}</p>
                <p class="text-gray-700"><strong>Overall Status:</strong> ${resolutionStatusText}</p>
                <p class="text-gray-700 text-sm">Note: ${task.note || 'N/A'}</p>
                <div class="mt-2 text-sm text-gray-500 flex items-center">
                    <span>by <strong>${task.user}</strong> at </span>
                    <span>${task.timestamp ? task.timestamp.toDate().toLocaleString() : 'Just now'}</span>
                    ${resolveButton}
                </div>`;
            container.appendChild(card);
        });
    }

    function displayAdminHistory(filterText = '', filterDate = '', preFilteredTasks = null) {
        const container = document.getElementById('admin-history');
        if (!container) return;

        let filteredTasks = preFilteredTasks !== null ? preFilteredTasks : allTasks;

        if (preFilteredTasks === null) {
            if (filterText) {
                const lowerFilterText = filterText.toLowerCase();
                filteredTasks = filteredTasks.filter(task =>
                    task.user.toLowerCase().includes(lowerFilterText) ||
                    task.tag.toLowerCase().includes(lowerFilterText)
                );
            }
            if (filterDate) {
                filteredTasks = filteredTasks.filter(task => {
                    if (!task.timestamp) return false;
                    return task.timestamp.toDate().toISOString().split('T')[0] === filterDate;
                });
            }
        }

        let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Done By</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tag</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Resolved</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
        filteredTasks.forEach(task => {
            const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
            let isError = task.status === 'Error' || // Old logic
                          errorStates.includes(task.status) ||
                          errorStates.includes(task.sound) ||
                          errorStates.includes(task.vibration) ||
                          errorStates.includes(task.temp) ||
                          errorStates.includes(task.shelter) ||
                          errorStates.includes(task.status_dirty_action) ||
                          errorStates.includes(task.sound_abnormal_source);
                          
            const isErrorAndUnresolved = isError && !task.resolvedByAdmin;
            const resolveButton = isErrorAndUnresolved
                ? `<button onclick="markPmTaskAsResolved('${task.id}', '${task.status}')" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600 transition">Mark Resolved</button>`
                : '';
            
            const statusText = isError ? 'Error' : 'OK';
                
            tableHTML += `<tr>
                                <td class="px-2 py-2 whitespace-nowrap">${task.user}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${task.zone || 'N/A'}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${task.tag}</td>
                                <td class="px-2 py-2 whitespace-nowrap max-w-xs truncate">${task.description}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${statusText}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${task.resolvedByAdmin ? 'Yes' : 'No'}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${task.timestamp ? task.timestamp.toDate().toLocaleString() : ''}</td>
                                <td class="px-2 py-2 whitespace-nowrap">${resolveButton}</td>
                           </tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }
    
    // --- ADMIN ANALYTICS, FILTERS, AND REPORTS ---
    function updateAdminAnalytics() {
        if (!allTasks || !allGreaseTasks || !document.getElementById('analytics-pm-today')) return;
        
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay());
        startOfWeek.setHours(0,0,0,0);

        // --- PM Tasks ---
        const pmTasksToday = allTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfToday);
        const pmTasksWeek = allTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfWeek);
        
        // --- Grease Tasks ---
        const greaseTasksToday = allGreaseTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfToday);
        const greaseTasksWeek = allGreaseTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfWeek);

        // --- Combined ---
        const totalTasksWeek = pmTasksWeek.length + greaseTasksWeek.length;
        const allActiveUsersToday = new Set([...pmTasksToday.map(t => t.user), ...greaseTasksToday.map(t => t.user)]);

        // --- Error States ---
        const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
        const isPmTaskError = (t) => {
            return t.status === 'Error' || // Old logic
                   errorStates.includes(t.status) ||
                   errorStates.includes(t.sound) ||
                   errorStates.includes(t.vibration) ||
                   errorStates.includes(t.temp) ||
                   errorStates.includes(t.shelter) ||
                   errorStates.includes(t.status_dirty_action) ||
                   errorStates.includes(t.sound_abnormal_source);
        };

        const unresolvedErrors = allTasks.filter(t => isPmTaskError(t) && !t.resolvedByAdmin);
        const totalErrorsWeek = pmTasksWeek.filter(isPmTaskError); // Includes resolved and unresolved

        // --- Update DOM ---
        document.getElementById('analytics-pm-today').textContent = pmTasksToday.length;
        document.getElementById('analytics-grease-today').textContent = greaseTasksToday.length;
        document.getElementById('analytics-unresolved-errors').textContent = unresolvedErrors.length;
        document.getElementById('analytics-users-active').textContent = allActiveUsersToday.size;
        
        document.getElementById('analytics-pm-week').textContent = pmTasksWeek.length;
        document.getElementById('analytics-grease-week').textContent = greaseTasksWeek.length;
        document.getElementById('analytics-total-tasks-week').textContent = totalTasksWeek;
        document.getElementById('analytics-total-errors-week').textContent = totalErrorsWeek.length;
    }


    function setupAdminFilters() {
        const textFilter = document.getElementById('history-search-text');
        const dateFilter = document.getElementById('history-search-date');
        const applyFilters = () => {
            displayAdminHistory(textFilter.value, dateFilter.value);
        };
        textFilter.addEventListener('keyup', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
    }
    
    window.filterHistoryByAnalytics = (filterType) => {
        const historyContainer = document.getElementById('admin-history');
        const greaseHistoryContainer = document.getElementById('admin-grease-history');
        const textFilter = document.getElementById('history-search-text');
        const dateFilter = document.getElementById('history-search-date');
        const greaseTextFilter = document.getElementById('grease-search-text');
        const greaseDateFilter = document.getElementById('grease-search-date');

        textFilter.value = '';
        dateFilter.value = '';
        greaseTextFilter.value = '';
        greaseDateFilter.value = '';

        let filteredPmTasks = [];
        let filteredGreaseTasks = [];
        const errorStates = ['Dirty', 'Abnormal', 'Not Exist', 'Not'];
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
        startOfWeek.setHours(0, 0, 0, 0);

        const isPmTaskError = (t) => {
            return t.status === 'Error' || errorStates.includes(t.status) || errorStates.includes(t.sound) ||
                   errorStates.includes(t.vibration) || errorStates.includes(t.temp) ||
                   errorStates.includes(t.shelter) || errorStates.includes(t.status_dirty_action) ||
                   errorStates.includes(t.sound_abnormal_source);
        };

        switch (filterType) {
            case 'pm_today':
                switchAdminView('pm');
                filteredPmTasks = allTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfToday);
                displayAdminHistory('', '', filteredPmTasks);
                historyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            case 'grease_today':
                switchAdminView('grease');
                filteredGreaseTasks = allGreaseTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfToday);
                displayAdminGreaseHistory(); // This will use the full list
                greaseHistoryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            case 'unresolved':
                switchAdminView('pm');
                filteredPmTasks = allTasks.filter(t => isPmTaskError(t) && !t.resolvedByAdmin);
                displayAdminHistory('', '', filteredPmTasks);
                historyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            case 'active_users':
                // This one is just a number, no table filter
                return;
            case 'pm_week':
                switchAdminView('pm');
                filteredPmTasks = allTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfWeek);
                displayAdminHistory('', '', filteredPmTasks);
                historyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            case 'grease_week':
                switchAdminView('grease');
                filteredGreaseTasks = allGreaseTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfWeek);
                displayAdminGreaseHistory(); // This will use the full list
                greaseHistoryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            case 'total_tasks_week':
                // No specific table, just a number
                return;
            case 'total_errors_week':
                switchAdminView('pm');
                filteredPmTasks = allTasks.filter(t => t.timestamp && t.timestamp.toDate() >= startOfWeek && isPmTaskError(t));
                displayAdminHistory('', '', filteredPmTasks);
                historyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
        }
    };


    function getTaskColorCode(task) {
        // Simplified logic for export
        const heat = task.temp;
        const motor_umbrella = task.shelter;
        
        const checks = {
            sound: task.sound === 'Normal',
            vibration: task.vibration === 'Normal',
            heat: heat === 'Normal',
            motor_umbrella: motor_umbrella === 'Exist',
            status: task.status === 'Clean'
        };

        if (!checks.sound && !checks.vibration && !checks.heat) {
            return { name: 'Black', text: 'Critical: Sound, Vibration, & Heat issues' };
        }
        if (!checks.heat) {
            return { name: 'Red', text: 'Danger: Heat issue' };
        }
        if (!checks.sound || !checks.vibration) {
            return { name: 'Orange', text: 'Warning: Sound/Vibration issue' };
        }
        if (!checks.status) {
            return { name: 'Yellow', text: `Attention: Status issue (${task.status})` };
        }
        if (!checks.motor_umbrella) {
            return { name: 'Blue', text: 'Notice: Motor Umbrella issue' };
        }
        return { name: 'Green', text: 'OK' };
    }

    window.exportToExcel = () => {
        const tasksToExport = allTasks;
        if (tasksToExport.length === 0) return showAlert("No data to export.");
        
        const reportHeaders = ["Done by", "Zone", "TAG", "Description", "Mode", "Status", "Status Action", "Sound", "Sound Source", "Vibration", "Temp", "Shelter", "Note", "Timestamp", "Color code"];
        
        let csvContent = reportHeaders.join(",") + "\r\n";
        
        tasksToExport.forEach(task => {
            const colorCode = getTaskColorCode(task);
            const row = [
                task.user,
                task.zone || 'N/A',
                task.tag,
                `"${(task.description || '').replace(/"/g, '""')}"`,
                task.inspectionMode || 'Online',
                task.status || 'N/A',
                task.status_dirty_action || 'N/A',
                task.sound || 'N/A',
                task.sound_abnormal_source || 'N/A',
                task.vibration || 'N/A',
                task.temp || 'N/A',
                task.shelter || 'N/A',
                `"${(task.note || '').replace(/"/g, '""')}"`,
                task.timestamp ? `"${task.timestamp.toDate().toLocaleDateString('en-GB')}"` : '',
                colorCode.name,
            ].join(",");
            csvContent += row + "\r\n";
        });

        csvContent += "\r\n\r\n";
        csvContent += "Color Code Legend\r\n";
        csvContent += "Green,OK (All checks are normal)\r\n";
        csvContent += "Blue,Notice: Motor Umbrella issue\r\n";
        csvContent += "Yellow,Attention: Status issue\r\n";
        csvContent += "Orange,Warning: Sound/Vibration issue\r\n";
        csvContent += "Red,Danger: Heat issue\r\n";
        csvContent += "Black,Critical: Sound, Vibration, & Heat issues\r\n";

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `pm_report_all_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    window.exportToPDF = () => {
        const tasksToExport = allTasks;
        if (tasksToExport.length === 0) return showAlert("No data to export.");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');

        const reportHeaders = ["Done by", "Zone", "TAG", "Description", "Status", "Sound", "Vibration", "Temp", "Shelter", "Timestamp"];

        const body = tasksToExport.map(task => {
            return [
                task.user,
                task.zone || 'N/A',
                task.tag,
                task.description,
                task.status || 'N/A',
                task.sound || 'N/A',
                task.vibration || 'N/A',
                task.temp || 'N/A',
                task.shelter || 'N/A',
                task.timestamp ? task.timestamp.toDate().toLocaleDateString('en-GB') : '',
            ];
        });

        doc.autoTable({
            head: [reportHeaders],
            body: body,
            startY: 10,
            styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' },
            columnStyles: { 3: { cellWidth: 50 }, 9: { cellWidth: 25 } },
        });

        doc.save(`pm_report_all_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    // --- DATA DELETION AND ARCHIVING FUNCTIONS ---
    window.closeConfirmClearModal = () => document.getElementById('confirm-clear-modal').classList.add('hidden');

    window.confirmClearAllData = () => {
        const pmView = document.getElementById('pm-view');
        const activeView = pmView.classList.contains('hidden') ? 'grease' : 'pm';
        
        let message = '';
        if (activeView === 'pm') {
            message = `Are you sure you want to delete <strong class="text-red-700">ALL PM history data</strong>? This action cannot be undone.`;
        } else {
            message = `Are you sure you want to delete <strong class="text-red-700">ALL Motor Grease history data</strong>? This action cannot be undone.`;
        }

        document.getElementById('confirm-clear-message').innerHTML = message;
        const yesButton = document.getElementById('confirm-clear-button-yes');
        yesButton.onclick = () => clearAllDataConfirmed(activeView); // Pass the active view to the confirmation function
        yesButton.innerText = "Yes, Delete All";
        document.getElementById('confirm-clear-modal').classList.remove('hidden');
    };


    async function clearAllDataConfirmed(dataType) {
        closeConfirmClearModal();
        showLoader();

        let collectionName = '';
        let recordTypeName = '';

        if (dataType === 'pm') {
            collectionName = 'pm_tasks';
            recordTypeName = 'PM';
        } else if (dataType === 'grease') {
            collectionName = 'grease_tasks';
            recordTypeName = 'Motor Grease';
        } else {
            showAlert('Unknown data type to delete.', 'Error');
            hideLoader();
            return;
        }

        try {
            const snapshot = await getDocs(collection(db, collectionName));
            if (snapshot.empty) {
                showAlert(`No ${recordTypeName} data to delete.`, "Info");
                hideLoader();
                return;
            }
            const batch = writeBatch(db);
            snapshot.forEach(docRef => {
                batch.delete(docRef.ref);
            });
            await batch.commit();
            showAlert(`Successfully deleted ${snapshot.size} ${recordTypeName} records.`, "Success");
        } catch (error) {
            console.error(`Error deleting all ${recordTypeName} documents: `, error);
            showAlert(`Failed to delete all ${recordTypeName} data.`, "Error");
        } finally {
            hideLoader();
        }
    };


    window.runCycleManually = async () => {
        await checkAndRunArchiveCycle(true);
    }

    async function checkAndRunArchiveCycle(forceRun = false) {
        userSettings.archiveSchedule.start = document.getElementById('start-date').value;
        userSettings.archiveSchedule.interval = document.getElementById('interval-duration').value;
        await saveSettings();
        const { archiveSchedule } = userSettings;
        if (!archiveSchedule.start || !archiveSchedule.interval) return;
        let startDate = new Date(archiveSchedule.start + "T00:00:00");
        let endDate = calculateEndDate(startDate, archiveSchedule.interval);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (forceRun || today > endDate) {
            const cycleStartDate = new Date(startDate);
            const cycleEndDate = new Date(endDate);
            showAlert('Archive cycle running...', 'Processing');
            showLoader();
            const endTimestamp = Timestamp.fromDate(new Date(cycleEndDate.getTime() + (24 * 60 * 60 * 1000) - 1));
            const q = query(collection(db, "pm_tasks"), where("timestamp", ">=", Timestamp.fromDate(cycleStartDate)), where("timestamp", "<=", endTimestamp));
            try {
                const snapshot = await getDocs(q);
                if (snapshot.size > 0) {
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                const newStartDate = new Date(cycleEndDate.getTime() + (24 * 60 * 60 * 1000));
                userSettings.archiveSchedule.start = newStartDate.toISOString().split('T')[0];
                await saveSettings();
                updateArchiveScheduleDisplay();
                showAlert(`Archive cycle complete. ${snapshot.size} records from ${cycleStartDate.toLocaleDateString()} to ${cycleEndDate.toLocaleDateString()} were deleted.`, 'Success');
            } catch (error) {
                console.error("Error during archive cycle: ", error);
                showAlert("Failed to complete archive cycle.", "Error");
            } finally {
                hideLoader();
            }
        } else if (forceRun) {
            showAlert(`The current archive period has not ended yet. The cycle will run after ${endDate.toLocaleDateString()}.`, 'Info');
        }
    }
    
    // --- NEW FUNCTIONS FOR ADMIN GREASE VIEW ---
    function listenForGreaseTasks() {
        if (unsubscribeGreaseTasks) unsubscribeGreaseTasks(); // Unsubscribe from previous listener
        const q = query(collection(db, "grease_tasks"), orderBy("timestamp", "desc"));
        unsubscribeGreaseTasks = onSnapshot(q, (snapshot) => {
            allGreaseTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentUser === 'Admin') {
                updateAdminAnalytics(); // Update with new grease tasks
            }
            displayAdminGreaseHistory(); // Call the display function when data changes
        }, (error) => {
            console.error("Firebase snapshot error for grease tasks: ", error);
        });
    }

    function displayAdminGreaseHistory() {
        const container = document.getElementById('admin-grease-history');
        if (!container) return;

        const textFilter = document.getElementById('grease-search-text').value.toLowerCase();
        const dateFilter = document.getElementById('grease-search-date').value;

        let filteredTasks = allGreaseTasks.filter(task => {
            const matchesText = !textFilter || task.user.toLowerCase().includes(textFilter) || task.tag.toLowerCase().includes(textFilter);
            const matchesDate = !dateFilter || (task.timestamp && task.timestamp.toDate().toISOString().split('T')[0] === dateFilter);
            return matchesText && matchesDate;
        });

        let tableHTML = `<table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50"><tr>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">User</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">TAG</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">Front Bearing</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">Rear Bearing</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">Grease (g)</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">Note</th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 uppercase">Timestamp</th>
            </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
        
        filteredTasks.forEach(task => {
            tableHTML += `<tr>
                <td class="px-2 py-2 whitespace-nowrap">${task.user}</td>
                <td class="px-2 py-2 whitespace-nowrap">${task.tag}</td>
                <td class="px-2 py-2 whitespace-nowrap">${task.frontBearingCondition}</td>
                <td class="px-2 py-2 whitespace-nowrap">${task.rearBearingCondition}</td>
                <td class="px-2 py-2 whitespace-nowrap">${task.greaseAmount}</td>
                <td class="px-2 py-2 whitespace-nowrap max-w-xs truncate">${task.note || 'N/A'}</td>
                <td class="px-2 py-2 whitespace-nowrap">${task.timestamp ? task.timestamp.toDate().toLocaleString() : ''}</td>
            </tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    window.exportGreaseToExcel = () => {
        if (allGreaseTasks.length === 0) return showAlert("No greasing data to export.");

        const headers = ["User", "TAG", "Description", "Front Bearing Available", "Front Bearing Condition", "Rear Bearing Available", "Rear Bearing Condition", "Grease Amount (g)", "Note", "Timestamp"];
        const customHeader = "Arab Potash Company,,,,Weekly Motor Grease,,,,Hot Leach Plant\r\n\r\n";
        let csvContent = customHeader + headers.join(",") + "\r\n";
        
        allGreaseTasks.forEach(task => {
            const row = [
                task.user,
                task.tag,
                `"${(task.description || '').replace(/"/g, '""')}"`,
                task.frontBearingAvailable,
                task.frontBearingCondition,
                task.rearBearingAvailable,
                task.rearBearingCondition,
                task.greaseAmount,
                `"${(task.note || '').replace(/"/g, '""')}"`,
                task.timestamp ? `"${task.timestamp.toDate().toLocaleDateString('en-GB')}"` : ''
            ].join(",");
            csvContent += row + "\r\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `grease_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    window.switchAdminView = (view) => {
        const pmView = document.getElementById('pm-view');
        const greaseView = document.getElementById('grease-view');
        const tabPm = document.getElementById('tab-pm');
        const tabGrease = document.getElementById('tab-grease');

        if (view === 'pm') {
            pmView.classList.remove('hidden');
            greaseView.classList.add('hidden');
            tabPm.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600';
            tabGrease.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
        } else {
            pmView.classList.add('hidden');
            greaseView.classList.remove('hidden');
            tabGrease.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600';
            tabPm.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
        }
    };
    
    // --- INITIALIZATION ---
    window.onload = async () => {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('./service-worker.js');
                console.log('Service Worker registered with scope:', registration.scope);
            } catch (error) {
                console.error('Service Worker registration failed:', error);
            }
        }
        
        if (localStorage.getItem('admin-remembered') === 'true') {
            showLoader();
            currentUser = 'Admin';
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-interface').classList.remove('hidden');
            await loadSettings();
            initializeAdminUI();
            await checkAndRunArchiveCycle();
            listenForTasks();
            listenForUserSettingsChanges();
            listenForGreaseTasks();
            hideLoader();
            return;
        }

        loadEquipmentData();
        await loadSettings();
        console.log("Application initialized successfully.");
    };

    document.getElementById('user-password-input').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            loginUserWithPassword();
        }
    });

    document.getElementById('admin-password').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            loginAdmin();
        }
    });

    document.getElementById('grease-search-text').addEventListener('keyup', displayAdminGreaseHistory);
    document.getElementById('grease-search-date').addEventListener('change', displayAdminGreaseHistory);
    
    document.getElementById('front-bearing-available').addEventListener('change', (e) => {
        document.getElementById('front-bearing-condition-block').classList.toggle('hidden', !e.target.checked);
    });

    document.getElementById('rear-bearing-available').addEventListener('change', (e) => {
        document.getElementById('rear-bearing-condition-block').classList.toggle('hidden', !e.target.checked);
    });
    </script>
</body>
</html>
